define(["controllers/controllers","config"],function(e,t){e.controller("login",["$rootScope","$location","$q","$scope","Session","Storage","$routeParams","MD5","Core",function(e,t,n,r,i,s,o,u,a){console.log("User 2 ->",a);var f=this;r.alert={login:{display:!1,type:"",message:""},forgot:{display:!1,type:"",message:""}},s.session.get("app")||s.session.add("app","{}"),$(".navbar").hide(),$("#footer").hide(),$("#preloader").hide();var l=angular.fromJson(s.get("logindata"));l&&l.remember&&(r.logindata=l);var c=$("#login button[type=submit]");r.login=function(){$("#alertDiv").hide();if(!r.logindata||!r.logindata.username||!r.logindata.password)return r.alert={login:{display:!0,type:"alert-error",message:"Please fill all fields!"}},c.text("Login").removeAttr("disabled"),!1;c.text("Login..").attr("disabled","disabled"),s.add("logindata",angular.toJson({username:r.logindata.username,password:r.logindata.password,remember:r.logindata.remember})),f.auth(r.logindata.username,u(r.logindata.password))},f.auth=function(e,t){User.login(e.toLowerCase(),t).then(function(e){if(e.status===403)return r.alert={login:{display:!0,type:"alert-error",message:"Wrong username or password!"}},c.text("Login").removeAttr("disabled"),!1;i.set(e["X-SESSION_ID"]),f.preloader()})},r.preloader={count:0,total:2,current:0,fraction:function(){return Math.abs(100/(this.total*2))}},f.preloader=function(){$("#login").hide(),$("#download").hide(),$("#preloader").show(),f.progress("Loading app related information.."),a.connections.list().then(function(){f.progress("Connected numbers are loaded"),f.appInit()}),a.settings.list().then(function(){f.progress("Notification settings loaded"),f.appInit()}),a.groups.list().then(function(){f.progress("Groups loaded"),f.appInit()})},f.appInit=function(){r.preloader.count++,f.progress(),r.preloader.count===r.preloader.total&&a.factory.process()&&(f.progress(),t.path("/core"),setTimeout(function(){$(".navbar").show(),e.browser.mobile||$("#footer").show()},100))},f.progress=function(e){r.preloader.current=r.preloader.current+r.preloader.fraction(),$("#preloader .progress .bar").css({width:r.preloader.current+"%"}),$("#preloader span").text(e)}}])});