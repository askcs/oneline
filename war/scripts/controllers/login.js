define(["controllers/controllers","config"],function(e,t){e.controller("login",["$rootScope","$location","$q","$scope","Session","User","Storage","$routeParams","MD5","Core",function(e,t,n,r,i,s,o,u,a,f){var l=this;r.alert={login:{display:!1,type:"",message:""},forgot:{display:!1,type:"",message:""}},o.session.get("app")||o.session.add("app","{}"),$(".navbar").hide(),$("#footer").hide(),$("#preloader").hide();var c=angular.fromJson(o.get("logindata"));c&&c.remember&&(r.logindata=c);var h=$("#login button[type=submit]");r.login=function(){$("#alertDiv").hide();if(!r.logindata||!r.logindata.username||!r.logindata.password)return r.alert={login:{display:!0,type:"alert-error",message:"Please fill all fields!"}},h.text("Login").removeAttr("disabled"),!1;h.text("Login..").attr("disabled","disabled"),o.add("logindata",angular.toJson({username:r.logindata.username,password:r.logindata.password,remember:r.logindata.remember})),l.auth(r.logindata.username,a(r.logindata.password))},l.auth=function(e,t){s.login(e.toLowerCase(),t).then(function(e){if(e.status===403)return r.alert={login:{display:!0,type:"alert-error",message:"Wrong username or password!"}},h.text("Login").removeAttr("disabled"),!1;i.set(e["X-SESSION_ID"]),l.preloader()})},r.preloader={count:0,total:2,current:0,fraction:function(){return Math.abs(100/(this.total*2))}},l.preloader=function(){$("#login").hide(),$("#download").hide(),$("#preloader").show(),l.progress("Loading app related information.."),f.connections.list().then(function(){l.progress("Connected numbers are loaded"),l.appInit()}),f.settings.list().then(function(){l.progress("Notification settings loaded"),l.appInit()}),f.groups.list().then(function(){l.progress("Groups loaded"),l.appInit()})},l.appInit=function(){r.preloader.count++,l.progress(),r.preloader.count===r.preloader.total&&f.factory.process()&&(l.progress(),t.path("/core"),setTimeout(function(){$(".navbar").show(),e.browser.mobile||$("#footer").show()},100))},l.progress=function(e){r.preloader.current=r.preloader.current+r.preloader.fraction(),$("#preloader .progress .bar").css({width:r.preloader.current+"%"}),$("#preloader span").text(e)}}])});